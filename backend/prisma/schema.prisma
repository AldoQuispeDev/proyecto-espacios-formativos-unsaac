generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//
enum Rol {
  ADMIN
  DOCENTE
  ESTUDIANTE
}

enum DiaSemana {
  LUNES
  MARTES
  MIERCOLES
  JUEVES
  VIERNES
}

//
// USUARIO (BASE)
//
model Usuario {
  id              Int      @id @default(autoincrement())
  nombre          String
  apellidoPaterno String
  apellidoMaterno String
  dni             String   @unique
  celular         String?
  correo          String   @unique
  password        String
  rol             Rol      @default(ESTUDIANTE)
  activo          Boolean  @default(true)
  creadoEn        DateTime @default(now())

  estudiante Estudiante?
  docente    Docente?
}

//
// ESTUDIANTE
//
model Estudiante {
  id        Int     @id @default(autoincrement())
  usuarioId Int     @unique
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  colegioProcedencia String?
  nombreApoderado    String?
  telefonoApoderado  String?

  matriculas Matricula[]
  inscripcionesClase InscripcionClase[]
  inscripcionesSeccion InscripcionSeccion[] 
}

//
// DOCENTE
//
model Docente {
  id        Int     @id @default(autoincrement())
  usuarioId Int     @unique
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  especialidad String?

  clases Clase[]
}

//
// MODALIDAD / GRADO
//
model Modalidad {
  id            Int    @id @default(autoincrement())
  nombre        String @unique // Ordinario CEPRU, Primera Oportunidad, etc.
  tipoGrado     String // Ordinario, Primera, Especial
  pisoPreferido Int
  pisoAlterno   Int?

  grupos     Grupo[]
  matriculas Matricula[]
}

//
// NIVEL ACAD√âMICO (seg√∫n nota)
//
model NivelAcademico {
  id      Int    @id @default(autoincrement())
  nombre  String // Avanzado, Intermedio, B√°sico
  notaMin Int
  notaMax Int

  secciones  Seccion[]
  matriculas Matricula[]
}

//
// GRUPO (A, B, C, D)
//
model Grupo {
  id          Int    @id @default(autoincrement())
  letra       String
  modalidadId Int

  modalidad   Modalidad @relation(fields: [modalidadId], references: [id])

  secciones   Seccion[]
  matriculas  Matricula[]
  asignaturas GrupoAsignatura[]

  clases      Clase[]  // ‚úÖ NUEVO

  @@unique([letra, modalidadId])
}


//
// TURNO
//
model Turno {
  id         Int    @id @default(autoincrement())
  nombre     String // MA√ëANA, TARDE
  horaInicio Int // 7:00 = 420
  horaFin    Int // 13:00 = 780 (ma√±ana)

  secciones Seccion[]
  clases    Clase[]
}

//
// SECCI√ìN (DIN√ÅMICA)
//
model Seccion {
  id               Int    @id @default(autoincrement())
  grupoId          Int
  nivelAcademicoId Int
  turnoId          Int
  codigo           String
  capacidadMax     Int    @default(40)

  grupo          Grupo          @relation(fields: [grupoId], references: [id])
  nivelAcademico NivelAcademico @relation(fields: [nivelAcademicoId], references: [id])
  turno          Turno          @relation(fields: [turnoId], references: [id])

  inscripciones   InscripcionSeccion[]
}


//
// ASIGNATURA
//
model Asignatura {
  id     Int    @id @default(autoincrement())
  nombre String @unique

  clases           Clase[]
  gruposAsignatura GrupoAsignatura[]
}

model GrupoAsignatura {
  id           Int @id @default(autoincrement())
  grupoId      Int
  asignaturaId Int
  preguntas    Int

  grupo      Grupo      @relation(fields: [grupoId], references: [id])
  asignatura Asignatura @relation(fields: [asignaturaId], references: [id])

  @@unique([grupoId, asignaturaId])
}

//
// AULA
//
model Aula {
  id        Int    @id @default(autoincrement())
  nombre    String @unique // 11, 12, 13...
  piso      Int
  capacidad Int    @default(40)

  clases Clase[]
  inscripciones    InscripcionSeccion[]
}

//
// CLASE (SESI√ìN DE 2 HORAS)
//
model Clase {
  id           Int @id @default(autoincrement())

  grupoId      Int
  docenteId    Int
  asignaturaId Int
  aulaId       Int
  turnoId      Int

  diaSemana     DiaSemana
  horaInicio    Int
  horaFin       Int
  esExcepcional Boolean @default(false)

  grupo      Grupo      @relation(fields: [grupoId], references: [id])
  docente    Docente    @relation(fields: [docenteId], references: [id])
  asignatura Asignatura @relation(fields: [asignaturaId], references: [id])
  aula       Aula       @relation(fields: [aulaId], references: [id])
  turno      Turno      @relation(fields: [turnoId], references: [id])

  inscripciones InscripcionClase[]

  @@unique([aulaId, diaSemana, horaInicio])
  @@unique([docenteId, diaSemana, horaInicio])
}



enum EstadoPago {
  PENDIENTE
  APROBADO
  RECHAZADO
}

model Pago {
  id Int @id @default(autoincrement())

  matriculaId Int
  matricula   Matricula @relation(fields: [matriculaId], references: [id])

  monto Float
  tipo TipoPago
  comprobanteUrl String?

  estado EstadoPago @default(PENDIENTE)

  createdAt DateTime @default(now())
}


//
// MATR√çCULA
//
enum EstadoMatricula {
  PENDIENTE
  APROBADA
  RECHAZADA
}

model Matricula {
  id Int @id @default(autoincrement())
  // üîπ Datos personales (temporales)
  nombre            String
  apellidoPaterno   String
  apellidoMaterno   String
  email             String
  telefono          String
  colegioProcedencia String

  estudianteId Int?
  estudiante   Estudiante? @relation(fields: [estudianteId], references: [id])

  dni String
  notaExamen Int?

  modalidadId Int
  modalidad   Modalidad @relation(fields: [modalidadId], references: [id])

  grupoId Int
  grupo   Grupo @relation(fields: [grupoId], references: [id])

  carreraPrincipalId Int
  carreraPrincipal Carrera @relation("CarreraPrincipal", fields: [carreraPrincipalId], references: [id])

  carreraSecundariaId Int?
  carreraSecundaria Carrera? @relation("CarreraSecundaria", fields: [carreraSecundariaId], references: [id])

  nivelAcademicoId Int?
  nivelAcademico   NivelAcademico? @relation(fields: [nivelAcademicoId], references: [id])

  turnoManana Boolean @default(false)
  turnoTarde  Boolean @default(false)

  estado EstadoMatricula @default(PENDIENTE)
  createdAt DateTime @default(now())

  // Pago
  tipoPago          String
  comprobanteUrl    String?


  pagos Pago[]

  @@unique([dni, modalidadId])
}



enum TipoPago {
  EFECTIVO
  TRANSFERENCIA
  YAPE_PLIN
}


model Carrera {
  id Int @id @default(autoincrement())
  nombre String @unique

  grupoCarreraId Int
  grupoCarrera GrupoCarrera @relation(fields: [grupoCarreraId], references: [id])

  matriculasPrincipal  Matricula[] @relation("CarreraPrincipal")
  matriculasSecundaria Matricula[] @relation("CarreraSecundaria")
}

model GrupoCarrera {
  id     Int    @id @default(autoincrement())
  codigo String @unique // A, B, C, D
  nombre String         // Ingenier√≠as, Salud, Econ√≥micas, Derecho/Educaci√≥n

  carreras Carrera[]
}


model InscripcionClase {
  id Int @id @default(autoincrement())

  estudianteId Int
  claseId      Int

  estudiante Estudiante @relation(fields: [estudianteId], references: [id])
  clase      Clase      @relation(fields: [claseId], references: [id])

  @@unique([estudianteId, claseId])
}


model InscripcionSeccion {
  id Int @id @default(autoincrement())

  estudianteId Int
  seccionId    Int
  aulaId       Int

  estudiante Estudiante @relation(fields: [estudianteId], references: [id])
  seccion    Seccion    @relation(fields: [seccionId], references: [id])
  aula       Aula       @relation(fields: [aulaId], references: [id])

  @@unique([estudianteId, seccionId])
}
