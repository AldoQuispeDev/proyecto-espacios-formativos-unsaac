//
// CONFIGURACI√ìN DE PRISMA
//
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// TABLA CENTRAL: Contiene credenciales y datos personales comunes
model Usuario {
  id              Int      @id @default(autoincrement())
  nombre          String
  apellidoPaterno String
  apellidoMaterno String
  dni             String   @unique // DNI debe ser unico
  celular         String?
  correo          String   @unique
  password        String
  rol             Rol      @default(ESTUDIANTE)
  activo          Boolean  @default(true)
  creadoEn        DateTime @default(now())

  // Relaciones 1:1
  estudiante Estudiante?
  docente    Docente?
}

//
// ENUM: ROLES DISPONIBLES
//
enum Rol {
  ADMIN
  DOCENTE
  ESTUDIANTE
}

// TABLA: ESTUDIANTE (Solo datos academicos especificos)
model Estudiante {
  id        Int     @id @default(autoincrement())
  usuarioId Int     @unique
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  fechaNacimiento   DateTime
  nombreApoderado   String?
  telefonoApoderado String?

  matriculas Matricula[]
}

// TABLA: DOCENTE (Nueva)
model Docente {
  id        Int     @id @default(autoincrement())
  usuarioId Int     @unique
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  especialidad String? // Ejemplo: Matematicas, Historia
  titulo       String? // Grado academico

  clases Clase[]
}

// --- MODELOS ACADEMICOS (Sin cambios mayores, solo limpieza) ---

model Modalidad {
  id         Int         @id @default(autoincrement())
  nombre     String      @unique
  grupos     Grupo[]
  matriculas Matricula[]
}

//
// üß© TABLA: GRUPO (A, B, C, D)
//
model Grupo {
  id          Int          @id @default(autoincrement())
  nombre      String
  modalidadId Int?
  modalidad   Modalidad?   @relation(fields: [modalidadId], references: [id])
  carreras    Carrera[]
  asignaturas Asignatura[]
  matriculas  Matricula[]
  clases      Clase[]
}

model Carrera {
  id                   Int         @id @default(autoincrement())
  nombre               String
  grupoId              Int
  grupo                Grupo       @relation(fields: [grupoId], references: [id])
  matriculasPrincipal  Matricula[] @relation("Principal")
  matriculasSecundaria Matricula[] @relation("Secundaria")
}

//
// üìö TABLA: ASIGNATURA
//
model Asignatura {
  id        Int     @id @default(autoincrement())
  nombre    String
  preguntas Int
  grupoId   Int
  grupo     Grupo   @relation(fields: [grupoId], references: [id])
  clases    Clase[]
}

//MATRICULA
model Matricula {
  id Int @id @default(autoincrement())

  // Estudiante (opcional - solo si ya tiene cuenta)
  estudianteId Int?
  estudiante   Estudiante? @relation(fields: [estudianteId], references: [id])

  // Datos personales del postulante (para matr√≠culas sin cuenta)
  nombre             String?
  apellidoPaterno    String?
  apellidoMaterno    String?
  dni                String   @unique
  email              String?
  telefono           String?
  colegioProcedencia String?

  // Relaciones acad√©micas
  grupoId Int
  grupo   Grupo @relation(fields: [grupoId], references: [id])

  modalidadId Int
  modalidad   Modalidad @relation(fields: [modalidadId], references: [id])

  carreraPrincipalId Int
  carreraPrincipal   Carrera @relation("Principal", fields: [carreraPrincipalId], references: [id])

  carreraSecundariaId Int?
  carreraSecundaria   Carrera? @relation("Secundaria", fields: [carreraSecundariaId], references: [id])

  // Datos de pago y estado
  tipoPago       String
  comprobanteUrl String?
  estado         String   @default("PENDIENTE")
  createdAt      DateTime @default(now())
}

// ‚ö†Ô∏è A√±adir a schema.prisma (dentro del bloque datasource db)

// Define los espacios f√≠sicos o virtuales
model Aula {
  id        Int     @id @default(autoincrement())
  nombre    String  @unique // Ej: Aula A-101, Virtual 1
  capacidad Int?
  clases    Clase[]
}

// Representa una instancia de clase o sesi√≥n programada
model Clase {
  id           Int      @id @default(autoincrement())
  docenteId    Int
  asignaturaId Int
  grupoId      Int
  aulaId       Int
  dia          String // Lunes, Martes, etc.
  horaInicio   DateTime // Hora de inicio (usar formato DateTime con fecha base)
  horaFin      DateTime // Hora de fin

  // Relaciones
  // Nota: Docente se relaciona con UsuarioId de la tabla Usuario a trav√©s de la tabla Docente
  docente    Docente    @relation(fields: [docenteId], references: [usuarioId])
  asignatura Asignatura @relation(fields: [asignaturaId], references: [id])
  grupo      Grupo      @relation(fields: [grupoId], references: [id])
  aula       Aula       @relation(fields: [aulaId], references: [id])

  // üõë RESTRICCIONES DE HORARIO (CR√çTICAS)
  // No puede haber dos clases en la misma aula al mismo tiempo, el mismo d√≠a.
  @@unique([aulaId, dia, horaInicio])
  // No puede haber un Docente dictando dos clases al mismo tiempo, el mismo d√≠a.
  @@unique([docenteId, dia, horaInicio])
}
